{
  "contentVersion": "1.0.0.0",
  "parameters": {
    "workbookDisplayName": {
      "type": "string",
      "defaultValue": "Defender for Endpoint Status",
      "metadata": {
        "description": "The friendly name for the workbook that is used in the Gallery or Saved List.  This name must be unique within a resource group."
      }
    },
    "workbookType": {
      "type": "string",
      "defaultValue": "workbook",
      "metadata": {
        "description": "The gallery that the workbook will been shown under. Supported values include workbook, tsg, etc. Usually, this is 'workbook'"
      }
    },
    "workbookSourceId": {
      "type": "string",
      "defaultValue": "Azure Security Center",
      "metadata": {
        "description": "The id of resource instance to which the workbook will be associated"
      }
    },
    "workbookId": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "metadata": {
        "description": "The unique guid for this workbook instance"
      }
    }
  },
  "resources": [
    {
      "name": "[parameters('workbookId')]",
      "type": "microsoft.insights/workbooks",
      "location": "[resourceGroup().location]",
      "apiVersion": "2021-03-08",
      "dependsOn": [],
      "kind": "shared",
      "properties": {
        "displayName": "[parameters('workbookDisplayName')]",
        "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"# Microsoft Defender for Endpoint Status\\nThis workbook provides an overview of Microsoft Defender for Endpoint deployments to Azure VMs and non-Azure machines connected via Azure Arc.\"},\"name\":\"text - 5\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"e13f2fd9-0eca-461d-bc7a-d472473e0f8f\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Subscriptions\",\"type\":6,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"includeAll\":false},\"timeContext\":{\"durationMs\":86400000},\"value\":[\"value::all\"]},{\"id\":\"2e935019-b639-4e4f-b196-7416d2e2e213\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"resourceType\",\"type\":10,\"isRequired\":true,\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"jsonData\":\"[\\n { \\\"value\\\": \\\"Azure\\\", \\\"label\\\": \\\"Azure VMs\\\"},\\n { \\\"value\\\": \\\"Arc\\\", \\\"label\\\": \\\"Azure Arc machines\\\"}\\n]\",\"value\":\"Azure\",\"label\":\"Resource Type\"}],\"style\":\"above\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\n| where type == 'microsoft.compute/virtualmachines'\\n| extend resourceId = tolower(id)\\n| join kind = leftouter (resources\\n    | where type == 'microsoft.compute/virtualmachines/extensions' and name has 'MDE'\\n    | extend resourceId = tolower((split(id, \\\"/extensions\\\"))[0])\\n) on resourceId\\n| extend state = iff(isnotempty(properties1.provisioningState), \\\"installed\\\", \\\"notInstalled\\\")\\n| summarize count() by state\\n\",\"size\":3,\"title\":\"Microsoft Defender for Endpoint Installation Status\",\"exportMultipleValues\":true,\"exportedParameters\":[{\"fieldName\":\"series\",\"parameterName\":\"installationState\",\"parameterType\":1}],\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscriptions}\"],\"visualization\":\"piechart\",\"chartSettings\":{\"seriesLabelSettings\":[{\"seriesName\":\"installed\",\"label\":\"MDE extension deployed\",\"color\":\"green\"},{\"seriesName\":\"notInstalled\",\"label\":\"MDE extension missing\",\"color\":\"redBright\"}]}},\"customWidth\":\"25\",\"name\":\"MDE-installationState\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\n| where type == 'microsoft.compute/virtualmachines'\\n| extend resourceId = tolower(id)\\n| join kind = leftouter (resources\\n| where type == 'microsoft.compute/virtualmachines/extensions' and name has 'MDE'\\n| extend resourceId = tolower((split(id, \\\"/extensions\\\"))[0]), state = properties.provisioningState\\n) on resourceId\\n| summarize count() by tostring(state) | where isnotempty(state)\",\"size\":0,\"title\":\"Microsoft Defender for Endpoint Extension Provisioning Status\",\"exportFieldName\":\"label\",\"exportParameterName\":\"deploymentState\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscriptions}\"],\"visualization\":\"barchart\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"resourceId\",\"formatter\":13,\"formatOptions\":{\"linkTarget\":\"Resource\",\"showIcon\":true}}]},\"tileSettings\":{\"showBorder\":false},\"graphSettings\":{\"type\":0},\"chartSettings\":{\"seriesLabelSettings\":[{\"seriesName\":\"Succeeded\",\"color\":\"green\"},{\"seriesName\":\"Failed\",\"color\":\"redBright\"},{\"seriesName\":\"Updating\",\"color\":\"yellow\"},{\"seriesName\":\"Creating\",\"color\":\"lightBlue\"}]},\"mapSettings\":{\"locInfo\":\"LatLong\",\"sizeSettings\":\"totalMachines\",\"sizeAggregation\":\"Sum\",\"legendMetric\":\"totalMachines\",\"legendAggregation\":\"Sum\",\"itemColorSettings\":{\"type\":\"heatmap\",\"colorAggregation\":\"Sum\",\"nodeColorField\":\"totalMachines\",\"heatmapPalette\":\"greenRed\"}}},\"customWidth\":\"75\",\"name\":\"MDE-extensionStatus\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\n| where type == 'microsoft.compute/virtualmachines'\\n| extend resourceId = tolower(id)\\n| join kind = leftouter (resources\\n    | where type == 'microsoft.compute/virtualmachines/extensions' and name has 'MDE'\\n    | extend resourceId = tolower((split(id, \\\"/extensions\\\"))[0])\\n) on resourceId\\n| extend state = iff(isnotempty(properties1.provisioningState), \\\"installed\\\", \\\"notInstalled\\\")\\n| where state == tostring(parse_json('{installationState}'))\\n| project id, subscriptionId, tenantId, location, resourceGroup, state\\n| join kind = inner ( securityresources\\n    | where type =~ \\\"microsoft.security/pricings\\\"\\n    | extend pricingTier = properties.pricingTier, subPlan = properties.subPlan\\n    | extend planSet = pack(name, level = case(isnotempty(subPlan),subPlan,pricingTier))\\n    | summarize defenderPlans = make_bag(planSet) by subscriptionId\\n    |Â project subscriptionId,\\n        DefenderForServers = defenderPlans.VirtualMachines\\n) on subscriptionId\",\"size\":3,\"showAnalytics\":true,\"title\":\"MDE Installation Details\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscriptions}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"$gen_group\",\"formatter\":15,\"formatOptions\":{\"linkTarget\":null,\"showIcon\":true}},{\"columnMatch\":\"subscriptionId1\",\"formatter\":5},{\"columnMatch\":\"DefenderForServers\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"P1\",\"representation\":\"success\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"P2\",\"representation\":\"success\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"3\",\"text\":\"{0}{1}\"}]}}],\"filter\":true,\"hierarchySettings\":{\"treeType\":1,\"groupBy\":[\"subscriptionId\"],\"expandTopLevel\":true},\"labelSettings\":[{\"columnId\":\"id\",\"label\":\"Machine ID\"},{\"columnId\":\"subscriptionId\",\"label\":\"Subscription ID\"},{\"columnId\":\"tenantId\",\"label\":\"Tenant ID\"},{\"columnId\":\"location\",\"label\":\"Azure Region\"},{\"columnId\":\"resourceGroup\",\"label\":\"Resource Group\"},{\"columnId\":\"state\",\"label\":\"MDE Installation Status\"},{\"columnId\":\"DefenderForServers\",\"label\":\"Defender for Servers Plan\"}]}},\"conditionalVisibility\":{\"parameterName\":\"installationState\",\"comparison\":\"isNotEqualTo\"},\"name\":\"MDE-installationDetails - query\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\n| where type == 'microsoft.compute/virtualmachines'\\n| extend resourceId = tolower(id)\\n| join kind = leftouter (resources\\n| where type == 'microsoft.compute/virtualmachines/extensions' and name has 'MDE'\\n| extend resourceId = tolower((split(id, \\\"/extensions\\\"))[0]), state = properties.provisioningState\\n) on resourceId\\n| where state == tostring(parse_json('{deploymentState}'))\\n| project id, subscriptionId, tenantId, location, resourceGroup, extensionId = id1, extensionName = name1, state\",\"size\":3,\"showAnalytics\":true,\"title\":\"MDE Extension Deployment Details\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscriptions}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"$gen_group\",\"formatter\":15,\"formatOptions\":{\"linkTarget\":null,\"showIcon\":true}}],\"filter\":true,\"hierarchySettings\":{\"treeType\":1,\"groupBy\":[\"subscriptionId\"],\"expandTopLevel\":true},\"labelSettings\":[{\"columnId\":\"id\",\"label\":\"Machine ID\"},{\"columnId\":\"subscriptionId\",\"label\":\"Subscription ID\"},{\"columnId\":\"tenantId\",\"label\":\"Tenant ID\"},{\"columnId\":\"location\",\"label\":\"Azure Region\"},{\"columnId\":\"resourceGroup\",\"label\":\"Resource Group\"},{\"columnId\":\"extensionId\",\"label\":\"Extension ID\"},{\"columnId\":\"extensionName\",\"label\":\"Extension Name\"},{\"columnId\":\"state\",\"label\":\"Deployment Status\"}]}},\"conditionalVisibility\":{\"parameterName\":\"deploymentState\",\"comparison\":\"isNotEqualTo\"},\"name\":\"MDE-extensionDeploymentDetails\"}]},\"conditionalVisibility\":{\"parameterName\":\"resourceType\",\"comparison\":\"isEqualTo\",\"value\":\"Azure\"},\"name\":\"AzureVMs\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\n| where type == 'microsoft.hybridcompute/machines'\\n| extend resourceId = tolower(id)\\n| join kind = leftouter (resources\\n    | where type == 'microsoft.hybridcompute/machines/extensions' and name has 'MDE'\\n    | extend resourceId = tolower((split(id, \\\"/extensions\\\"))[0])\\n) on resourceId\\n| extend state = iff(isnotempty(properties1.provisioningState), \\\"installed\\\", \\\"notInstalled\\\")\\n| summarize count() by state\\n\",\"size\":3,\"title\":\"Microsoft Defender for Endpoint Installation Status\",\"noDataMessage\":\"No Azure Arc machines found based on your selection.\",\"exportMultipleValues\":true,\"exportedParameters\":[{\"fieldName\":\"series\",\"parameterName\":\"installationState\",\"parameterType\":1}],\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscriptions}\"],\"visualization\":\"piechart\",\"chartSettings\":{\"seriesLabelSettings\":[{\"seriesName\":\"installed\",\"label\":\"MDE extension deployed\",\"color\":\"green\"},{\"seriesName\":\"notInstalled\",\"label\":\"MDE extension missing\",\"color\":\"redBright\"}]}},\"customWidth\":\"25\",\"name\":\"MDE-installationState\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\n| where type == 'microsoft.hybridcompute/machines'\\n| extend resourceId = tolower(id)\\n| join kind = leftouter (resources\\n| where type == 'microsoft.hybridcompute/machines/extensions' and name has 'MDE'\\n| extend resourceId = tolower((split(id, \\\"/extensions\\\"))[0]), state = properties.provisioningState\\n) on resourceId\\n| summarize count() by tostring(state) | where isnotempty(state)\",\"size\":0,\"title\":\"Microsoft Defender for Endpoint Extension Provisioning Status\",\"noDataMessage\":\"No Azure Arc machines found based on your selection.\",\"exportFieldName\":\"label\",\"exportParameterName\":\"deploymentState\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscriptions}\"],\"visualization\":\"barchart\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"resourceId\",\"formatter\":13,\"formatOptions\":{\"linkTarget\":\"Resource\",\"showIcon\":true}}]},\"tileSettings\":{\"showBorder\":false},\"graphSettings\":{\"type\":0},\"chartSettings\":{\"seriesLabelSettings\":[{\"seriesName\":\"Succeeded\",\"color\":\"green\"},{\"seriesName\":\"Failed\",\"color\":\"redBright\"},{\"seriesName\":\"Updating\",\"color\":\"yellow\"},{\"seriesName\":\"Creating\",\"color\":\"lightBlue\"}]},\"mapSettings\":{\"locInfo\":\"LatLong\",\"sizeSettings\":\"totalMachines\",\"sizeAggregation\":\"Sum\",\"legendMetric\":\"totalMachines\",\"legendAggregation\":\"Sum\",\"itemColorSettings\":{\"type\":\"heatmap\",\"colorAggregation\":\"Sum\",\"nodeColorField\":\"totalMachines\",\"heatmapPalette\":\"greenRed\"}}},\"customWidth\":\"75\",\"name\":\"MDE-extensionStatus\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\n| where type == 'microsoft.hybridcompute/machines'\\n| extend resourceId = tolower(id)\\n| join kind = leftouter (resources\\n    | where type == 'microsoft.hybridcompute/machines/extensions' and name has 'MDE'\\n    | extend resourceId = tolower((split(id, \\\"/extensions\\\"))[0])\\n) on resourceId\\n| extend state = iff(isnotempty(properties1.provisioningState), \\\"installed\\\", \\\"notInstalled\\\")\\n| where state == tostring(parse_json('{installationState}'))\\n| project id, subscriptionId, tenantId, location, resourceGroup, state\\n| join kind = inner ( securityresources\\n    | where type =~ \\\"microsoft.security/pricings\\\"\\n    | extend pricingTier = properties.pricingTier, subPlan = properties.subPlan\\n    | extend planSet = pack(name, level = case(isnotempty(subPlan),subPlan,pricingTier))\\n    | summarize defenderPlans = make_bag(planSet) by subscriptionId\\n    |Â project subscriptionId,\\n        DefenderForServers = defenderPlans.VirtualMachines\\n) on subscriptionId\",\"size\":3,\"showAnalytics\":true,\"title\":\"MDE Installation Details\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscriptions}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"$gen_group\",\"formatter\":15,\"formatOptions\":{\"linkTarget\":null,\"showIcon\":true}},{\"columnMatch\":\"subscriptionId1\",\"formatter\":5},{\"columnMatch\":\"DefenderForServers\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"P1\",\"representation\":\"success\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"P2\",\"representation\":\"success\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"3\",\"text\":\"{0}{1}\"}]}}],\"filter\":true,\"hierarchySettings\":{\"treeType\":1,\"groupBy\":[\"subscriptionId\"],\"expandTopLevel\":true},\"labelSettings\":[{\"columnId\":\"id\",\"label\":\"Machine ID\"},{\"columnId\":\"subscriptionId\",\"label\":\"Subscription ID\"},{\"columnId\":\"tenantId\",\"label\":\"Tenant ID\"},{\"columnId\":\"location\",\"label\":\"Azure Region\"},{\"columnId\":\"resourceGroup\",\"label\":\"Resource Group\"},{\"columnId\":\"state\",\"label\":\"MDE Installation Status\"},{\"columnId\":\"DefenderForServers\",\"label\":\"Defender for Servers Plan\"}]}},\"conditionalVisibility\":{\"parameterName\":\"installationState\",\"comparison\":\"isNotEqualTo\"},\"name\":\"MDE-installationDetails - query\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\n| where type == 'microsoft.hybridcompute/machines'\\n| extend resourceId = tolower(id)\\n| join kind = leftouter (resources\\n| where type == 'microsoft.hybridcompute/machines/extensions' and name has 'MDE'\\n| extend resourceId = tolower((split(id, \\\"/extensions\\\"))[0]), state = properties.provisioningState, errorMessage = properties.instanceView.status.message\\n) on resourceId\\n| where state == tostring(parse_json('{deploymentState}'))\\n| project id, subscriptionId, tenantId, location, resourceGroup, extensionId = id1, extensionName = name1, extensionProvisioningState = properties1.provisioningState, errorMessage\",\"size\":3,\"showAnalytics\":true,\"title\":\"MDE Extension Deployment Details\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscriptions}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"$gen_group\",\"formatter\":15,\"formatOptions\":{\"linkTarget\":null,\"showIcon\":true}}],\"filter\":true,\"hierarchySettings\":{\"treeType\":1,\"groupBy\":[\"subscriptionId\"],\"expandTopLevel\":true},\"labelSettings\":[{\"columnId\":\"id\",\"label\":\"Machine ID\"},{\"columnId\":\"subscriptionId\",\"label\":\"Subscription ID\"},{\"columnId\":\"tenantId\",\"label\":\"Tenant ID\"},{\"columnId\":\"location\",\"label\":\"Azure Region\"},{\"columnId\":\"resourceGroup\",\"label\":\"Resource Group\"},{\"columnId\":\"extensionId\",\"label\":\"Extension ID\"},{\"columnId\":\"extensionName\",\"label\":\"Extension Name\"},{\"columnId\":\"extensionProvisioningState\",\"label\":\"Extension Provisioning State\"},{\"columnId\":\"errorMessage\",\"label\":\"Provisioning Details\"}]}},\"conditionalVisibility\":{\"parameterName\":\"deploymentState\",\"comparison\":\"isNotEqualTo\"},\"name\":\"MDE-extensionDeploymentDetails\"}]},\"conditionalVisibility\":{\"parameterName\":\"resourceType\",\"comparison\":\"isEqualTo\",\"value\":\"Arc\"},\"name\":\"AzureArc\"}],\"isLocked\":false,\"fallbackResourceIds\":[\"Azure Security Center\"],\"fromTemplateId\":\"asc-mde-dashboard\"}",
        "version": "1.0",
        "sourceId": "[parameters('workbookSourceId')]",
        "category": "[parameters('workbookType')]"
      }
    }
  ],
  "outputs": {
    "workbookId": {
      "type": "string",
      "value": "[resourceId( 'microsoft.insights/workbooks', parameters('workbookId'))]"
    }
  },
  "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#"
}